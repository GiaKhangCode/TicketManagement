-- 1. Tạo bảng USERS
CREATE TABLE USERS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME VARCHAR2(50) UNIQUE NOT NULL,
    PASSWORD VARCHAR2(255) NOT NULL,
    EMAIL VARCHAR2(100) UNIQUE NOT NULL,
    FULL_NAME VARCHAR2(100),
    ROLE VARCHAR2(20) CHECK (ROLE IN ('CUSTOMER', 'ORGANIZER', 'ADMIN')) NOT NULL,
    IS_LOCKED NUMBER(1) DEFAULT 0, -- Từ Migration V6
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. Tạo bảng EVENTS
CREATE TABLE EVENTS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(255) NOT NULL,
    DESCRIPTION CLOB,
    LOCATION VARCHAR2(255),
    START_TIME TIMESTAMP NOT NULL,
    END_TIME TIMESTAMP,
    ORGANIZER_ID NUMBER NOT NULL,
    STATUS VARCHAR2(20) DEFAULT 'PENDING' CHECK (STATUS IN ('PENDING', 'APPROVED', 'REJECTED')),
    IMAGE_URL VARCHAR2(500),
    CATEGORY VARCHAR2(100),
    FOREIGN KEY (ORGANIZER_ID) REFERENCES USERS(ID)
);

-- 3. Tạo bảng EVENT_SCHEDULES (Lịch diễn chi tiết)
CREATE TABLE EVENT_SCHEDULES (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EVENT_ID NUMBER NOT NULL,
    START_TIME TIMESTAMP NOT NULL,
    END_TIME TIMESTAMP,
    FOREIGN KEY (EVENT_ID) REFERENCES EVENTS(ID)
);

-- 4. Tạo bảng TICKET_TYPES (Hạng vé)
CREATE TABLE TICKET_TYPES (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EVENT_ID NUMBER NOT NULL,
    NAME VARCHAR2(50) NOT NULL, -- VIP, Standard, etc.
    PRICE NUMBER(15, 2) NOT NULL,
    QUANTITY NUMBER NOT NULL, -- Tổng số vé phát hành
    SOLD NUMBER DEFAULT 0, -- Số vé đã bán
    FOREIGN KEY (EVENT_ID) REFERENCES EVENTS(ID)
);

-- 5. Tạo bảng BOOKINGS (Đơn hàng)
CREATE TABLE BOOKINGS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USER_ID NUMBER NOT NULL,
    BOOKING_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    TOTAL_AMOUNT NUMBER(15, 2) NOT NULL,
    STATUS VARCHAR2(20) DEFAULT 'SUCCESS',
    SCHEDULE_ID NUMBER,
    FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
    FOREIGN KEY (SCHEDULE_ID) REFERENCES EVENT_SCHEDULES(ID)
);

-- 6. Tạo bảng TICKETS (Vé chi tiết - dùng cho check-in)
CREATE TABLE TICKETS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    BOOKING_ID NUMBER NOT NULL,
    TICKET_TYPE_ID NUMBER NOT NULL,
    QR_CODE VARCHAR2(255) UNIQUE NOT NULL,
    STATUS VARCHAR2(20) DEFAULT 'VALID' CHECK (STATUS IN ('VALID', 'USED', 'CANCELLED')),
    IS_RESALE NUMBER(1) DEFAULT 0, -- Từ Migration V9
    RESALE_PRICE NUMBER(10, 2) DEFAULT 0, -- Từ Migration V9
    FOREIGN KEY (BOOKING_ID) REFERENCES BOOKINGS(ID),
    FOREIGN KEY (TICKET_TYPE_ID) REFERENCES TICKET_TYPES(ID)
);

-- 7. Tạo bảng SHOWCASES (Danh mục hiển thị trang chủ)
CREATE TABLE SHOWCASES (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL,
    DISPLAY_ORDER NUMBER DEFAULT 0,
    IS_ACTIVE NUMBER(1) DEFAULT 1
);

-- 8. Tạo bảng SHOWCASE_EVENTS (Mapping giữa Showcase và Event)
CREATE TABLE SHOWCASE_EVENTS (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    SHOWCASE_ID NUMBER NOT NULL,
    EVENT_ID NUMBER NOT NULL,
    DISPLAY_ORDER NUMBER DEFAULT 0,
    FOREIGN KEY (SHOWCASE_ID) REFERENCES SHOWCASES(ID),
    FOREIGN KEY (EVENT_ID) REFERENCES EVENTS(ID)
);

-- 9. Tạo bảng REVIEWS (Đánh giá) - Từ Migration V7
CREATE TABLE REVIEWS (
    ID INT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    USER_ID INT NOT NULL,
    EVENT_ID INT NOT NULL,
    RATING INT CHECK (RATING >= 1 AND RATING <= 5),
    COMMENT_TEXT CLOB,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_REVIEW_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID),
    CONSTRAINT FK_REVIEW_EVENT FOREIGN KEY (EVENT_ID) REFERENCES EVENTS(ID)
);

-- 10. Tạo bảng EVENT_SEAT_MAPS (Lưu trữ sơ đồ ghế) - Từ Migration V8
CREATE TABLE EVENT_SEAT_MAPS (
    EVENT_ID NUMBER PRIMARY KEY,
    MAP_DATA CLOB CHECK (MAP_DATA IS JSON), -- Oracle 12c+ support JSON constraint check
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT FK_MAP_EVENT FOREIGN KEY (EVENT_ID) REFERENCES EVENTS(ID) ON DELETE CASCADE
);

-- ==========================================
-- DỮ LIỆU MẪU (SEED DATA)
-- ==========================================

-- Users
INSERT INTO USERS (USERNAME, PASSWORD, EMAIL, FULL_NAME, ROLE) VALUES ('admin', 'admin123', 'admin@ticketbox.com', 'System Administrator', 'ADMIN');
INSERT INTO USERS (USERNAME, PASSWORD, EMAIL, FULL_NAME, ROLE) VALUES ('organizer', '123456', 'org@ticketbox.com', 'Vietnam Event Company', 'ORGANIZER');
INSERT INTO USERS (USERNAME, PASSWORD, EMAIL, FULL_NAME, ROLE) VALUES ('customer', '123456', 'cust@gmail.com', 'Nguyen Van A', 'CUSTOMER');

-- Showcases mặc định
INSERT INTO SHOWCASES (NAME, DISPLAY_ORDER) VALUES ('Sự kiện đặc biệt', 1);
INSERT INTO SHOWCASES (NAME, DISPLAY_ORDER) VALUES ('Sự kiện xu hướng', 2);
